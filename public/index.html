<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Status Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .status-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online {
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-text {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .status-text.online {
            color: #10b981;
        }
        
        .status-text.offline {
            color: #ef4444;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            padding: 15px;
            background: #f3f4f6;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #1f2937;
        }
        
        .history-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .history-card h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .history-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-time {
            color: #6b7280;
            font-size: 0.9em;
        }
        
        .history-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .history-status.online {
            background: #d1fae5;
            color: #065f46;
        }
        
        .history-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
            min-height: 300px;
        }
        
        #statusChart {
            max-height: 300px;
        }
        
        .offline-log {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .offline-log strong {
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì° ESP32 Status Monitor</h1>
            <p>Real-time device monitoring dashboard</p>
        </div>
        
        <div id="error-container"></div>
        
        <div class="status-card">
            <div class="status-indicator">
                <div id="status-dot" class="status-dot offline"></div>
                <div id="status-text" class="status-text offline">OFFLINE</div>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Last Seen</div>
                    <div id="last-seen" class="info-value">Never</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Time Since Last Update</div>
                    <div id="time-since" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Uptime</div>
                    <div id="uptime" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">IP Address</div>
                    <div id="ip-address" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Signal Strength</div>
                    <div id="rssi" class="info-value">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Free Memory</div>
                    <div id="free-heap" class="info-value">--</div>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>üìä Online/Offline Timeline (Last 24 Hours)</h2>
            <div class="chart-wrapper">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        
        <div class="status-card" id="offline-events-card" style="display: none;">
            <h2 style="margin-bottom: 15px; color: #1f2937;">‚ö†Ô∏è Offline Events</h2>
            <div id="offline-events-container"></div>
        </div>
        
        <div class="history-card">
            <h2>Recent Activity</h2>
            <div id="history-container">
                <div class="loading">Loading history...</div>
            </div>
        </div>
    </div>
    
    <script>
        let updateInterval;
        let statusChart;
        
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Status',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: -0.1,
                            max: 1.1,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    if (value === 1) return 'Online';
                                    if (value === 0) return 'Offline';
                                    return '';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 24,
                                autoSkip: true
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y === 1 ? 'Online' : 'Offline';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateUI(data);
                document.getElementById('error-container').innerHTML = '';
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('error-container').innerHTML = 
                    '<div class="error">Error connecting to server. Make sure your ESP32 is sending updates.</div>';
            }
        }
        
        function updateUI(data) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (data.status === 'online') {
                statusDot.className = 'status-dot online';
                statusText.className = 'status-text online';
                statusText.textContent = 'ONLINE';
            } else {
                statusDot.className = 'status-dot offline';
                statusText.className = 'status-text offline';
                statusText.textContent = 'OFFLINE';
            }
            
            // Format time in local timezone - ensure proper conversion
            let lastSeenDate = null;
            if (data.last_seen) {
                // Ensure proper timezone conversion
                lastSeenDate = new Date(data.last_seen + (data.last_seen.includes('Z') ? '' : 'Z'));
            }
            document.getElementById('last-seen').textContent = 
                lastSeenDate ? lastSeenDate.toLocaleString(undefined, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                }) : 'Never';
            
            document.getElementById('time-since').textContent = 
                data.minutes_since_last_seen !== undefined 
                    ? `${data.minutes_since_last_seen.toFixed(1)} minutes ago`
                    : '--';
            
            if (data.latest_update) {
                document.getElementById('uptime').textContent = 
                    data.latest_update.uptime_formatted || '--';
                document.getElementById('ip-address').textContent = 
                    data.latest_update.ip_address || '--';
                document.getElementById('rssi').textContent = 
                    data.latest_update.rssi ? `${data.latest_update.rssi} dBm` : '--';
                document.getElementById('free-heap').textContent = 
                    data.latest_update.free_heap ? `${(data.latest_update.free_heap / 1024).toFixed(1)} KB` : '--';
            }
        }
        
        async function fetchHistory() {
            try {
                const response = await fetch('/api/history?limit=200');
                const history = await response.json();
                
                const container = document.getElementById('history-container');
                
                if (history.length === 0) {
                    container.innerHTML = '<div class="loading">No history available yet</div>';
                    if (statusChart) {
                        // Show empty chart
                        statusChart.data.labels = [];
                        statusChart.data.datasets[0].data = [];
                        statusChart.update();
                    }
                    return;
                }
                
                console.log('Fetched history:', history.length, 'items');
                
                // Update chart with history data (await to ensure current status is fetched)
                updateChart(history).catch(err => console.error('Chart update error:', err));
                
                // Detect offline events
                detectOfflineEvents(history);
                
                // Display recent history
                container.innerHTML = history.slice(0, 20).map(item => {
                    // Fix timezone - ensure proper conversion to local time
                    const serverTime = item.server_timestamp;
                    const date = new Date(serverTime + (serverTime.includes('Z') ? '' : 'Z'));
                    const localTime = date.toLocaleString(undefined, {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                    const isBoot = item.is_boot === 1;
                    const isOfflineMarker = item.is_offline_marker;
                    return `
                        <div class="history-item">
                            <div>
                                <div class="history-time">${localTime}</div>
                                <div>${isOfflineMarker ? '‚ö†Ô∏è Device Offline' : isBoot ? 'üîÑ Device Booted' : 'üì° Status Update'} | Uptime: ${item.uptime_formatted || 'N/A'}</div>
                            </div>
                            <div class="history-status ${item.status || 'offline'}">${(item.status || 'offline').toUpperCase()}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching history:', error);
            }
        }
        
        async function updateChart(history) {
            if (!statusChart) {
                console.error('Chart not initialized');
                return;
            }
            
            try {
                if (!history || history.length === 0) {
                    console.log('No history data for chart');
                    return;
                }
                
                // Get current status
                let currentStatusIsOffline = false;
                try {
                    const statusResponse = await fetch('/api/status');
                    const statusData = await statusResponse.json();
                    currentStatusIsOffline = statusData.status === 'offline';
                } catch (e) {
                    console.error('Error fetching current status:', e);
                }
                
                // Get last 24 hours of data
                const now = new Date();
                const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);
                
                // Filter and process data
                const recentHistory = history.filter(item => {
                    if (!item.server_timestamp) return false;
                    try {
                        const itemTime = item.server_timestamp.includes('Z') ? item.server_timestamp : item.server_timestamp + 'Z';
                        const itemDate = new Date(itemTime);
                        return !isNaN(itemDate.getTime()) && itemDate >= oneDayAgo;
                    } catch (e) {
                        return false;
                    }
                });
                
                console.log('Recent history for chart:', recentHistory.length, 'items');
                
                // Create time buckets - use actual data points, not fixed intervals
                // Sort history by time
                const sortedHistory = [...recentHistory].sort((a, b) => {
                    const timeA = (a.server_timestamp.includes('Z') ? a.server_timestamp : a.server_timestamp + 'Z');
                    const timeB = (b.server_timestamp.includes('Z') ? b.server_timestamp : b.server_timestamp + 'Z');
                    return new Date(timeA) - new Date(timeB);
                });
                
                // Create data points: for each status update, determine if online (1) or offline (0)
                const labels = [];
                const data = [];
                const colors = [];
                
                // Process each history item
                sortedHistory.forEach((item, index) => {
                    if (!item.server_timestamp) return;
                    
                    try {
                        const itemTime = item.server_timestamp.includes('Z') ? item.server_timestamp : item.server_timestamp + 'Z';
                        const itemDate = new Date(itemTime);
                        
                        if (isNaN(itemDate.getTime())) return;
                        
                        // Create label
                        const timeLabel = itemDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        labels.push(timeLabel);
                        
                        // Determine status: 1 = online, 0 = offline
                        let status = 1; // Default to online
                        if (item.is_offline_marker || item.status === 'offline') {
                            status = 0; // Offline
                        }
                        
                        data.push(status);
                        
                        // Set color
                        if (status === 1) {
                            colors.push('rgba(16, 185, 129, 0.4)'); // Green
                        } else {
                            colors.push('rgba(239, 68, 68, 0.4)'); // Red
                        }
                    } catch (e) {
                        console.error('Error processing history item:', e);
                    }
                });
                
                // Add current status if not in history
                if (labels.length === 0 || (currentStatusIsOffline && data[data.length - 1] !== 0) || (!currentStatusIsOffline && data[data.length - 1] !== 1)) {
                    labels.push(now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                    data.push(currentStatusIsOffline ? 0 : 1);
                    colors.push(currentStatusIsOffline ? 'rgba(239, 68, 68, 0.4)' : 'rgba(16, 185, 129, 0.4)');
                }
                
                // Limit to last 100 points for performance
                if (labels.length > 100) {
                    const start = labels.length - 100;
                    labels.splice(0, start);
                    data.splice(0, start);
                    colors.splice(0, start);
                }
                
                // Update chart
                if (labels.length > 0 && data.length > 0) {
                    statusChart.data.labels = labels;
                    statusChart.data.datasets[0].data = data;
                    statusChart.data.datasets[0].backgroundColor = colors;
                    statusChart.data.datasets[0].borderColor = '#10b981';
                    statusChart.data.datasets[0].pointRadius = 3;
                    statusChart.data.datasets[0].pointHoverRadius = 5;
                    statusChart.update();
                    console.log('Chart updated:', data.length, 'points | Online (1):', data.filter(d => d === 1).length, '| Offline (0):', data.filter(d => d === 0).length);
                } else {
                    console.log('No data points to display in chart');
                }
            } catch (error) {
                console.error('Error updating chart:', error);
            }
        }
        
        function detectOfflineEvents(history) {
            const offlineEvents = [];
            
            // Sort by timestamp - fix timezone conversion
            const sortedHistory = [...history].sort((a, b) => {
                const timeA = a.server_timestamp + (a.server_timestamp.includes('Z') ? '' : 'Z');
                const timeB = b.server_timestamp + (b.server_timestamp.includes('Z') ? '' : 'Z');
                return new Date(timeA) - new Date(timeB);
            });
            
            for (let i = 0; i < sortedHistory.length - 1; i++) {
                const currentTime = sortedHistory[i].server_timestamp + (sortedHistory[i].server_timestamp.includes('Z') ? '' : 'Z');
                const nextTime = sortedHistory[i + 1].server_timestamp + (sortedHistory[i + 1].server_timestamp.includes('Z') ? '' : 'Z');
                const current = new Date(currentTime);
                const next = new Date(nextTime);
                const gapMinutes = (next - current) / 1000 / 60;
                
                // If gap is more than 1 minute, it's an offline period
                if (gapMinutes > 1) {
                    offlineEvents.push({
                        start: current,
                        end: next,
                        duration: gapMinutes
                    });
                }
            }
            
            // Display offline events
            const container = document.getElementById('offline-events-container');
            const card = document.getElementById('offline-events-card');
            
            if (offlineEvents.length > 0) {
                card.style.display = 'block';
                container.innerHTML = offlineEvents.slice(-10).reverse().map(event => {
                    // Fix timezone for offline events
                    const startTime = event.start.toLocaleString(undefined, {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                    const endTime = event.end.toLocaleString(undefined, {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });
                    return `
                        <div class="offline-log">
                            <strong>‚ö†Ô∏è Device went offline</strong><br>
                            From: ${startTime}<br>
                            To: ${endTime}<br>
                            Duration: ${Math.round(event.duration)} minutes
                        </div>
                    `;
                }).join('');
            } else {
                card.style.display = 'none';
            }
        }
        
        // Wait for page to fully load before initializing chart
        window.addEventListener('load', () => {
            // Initialize chart
            try {
                initChart();
                console.log('Chart initialized');
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
            
            // Initial load
            fetchStatus();
            fetchHistory();
            
            // Update every 5 seconds
            updateInterval = setInterval(() => {
                fetchStatus();
                fetchHistory();
            }, 5000);
        });
    </script>
</body>
</html>

